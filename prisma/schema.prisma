generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["views", "relationJoins"]
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Player {
  membershipId                BigInt                  @id @map("membership_id")
  membershipType              Int?                    @map("membership_type")
  iconPath                    String?                 @map("icon_path")
  displayName                 String?                 @map("display_name")
  bungieGlobalDisplayName     String?                 @map("bungie_global_display_name")
  bungieGlobalDisplayNameCode String?                 @map("bungie_global_display_name_code")
  bungieName                  String?                 @default(dbgenerated("\nCASE\n    WHEN ((bungie_global_display_name IS NOT NULL) AND (bungie_global_display_name_code IS NOT NULL)) THEN ((bungie_global_display_name || '#'::text) || bungie_global_display_name_code)\n    ELSE display_name\nEND")) @map("bungie_name")
  lastSeen                    DateTime                @map("last_seen")
  clears                      Int                     @default(0) @map("clears")
  fullClears                  Int                     @default(0) @map("fresh_clears")
  sherpas                     Int                     @default(0) @map("sherpas")
  sumOfBestTimes              Int?                    @map("sum_of_best")
  lastCrawled                 DateTime?               @map("last_crawled")
  searchScore                 Decimal?                @default(dbgenerated("(sqrt(((clears + 1))::double precision) * power((2)::double precision, (GREATEST((0)::double precision, date_part('epoch'::text, (last_seen - '2017-08-27 00:00:00'::timestamp without time zone))) / (20000000)::double precision)))")) @map("_search_score") @db.Decimal
  activityPlayer              ActivityPlayer[]
  stats                       PlayerStats[]           @relation("player_stats_membership_id")
  individualLeaderboards      IndividualLeaderboard[] @relation("individual_leaderboard")
  globalRanks                 GlobalLeaderboard?      @relation("global_leaderboard")

  @@map("player")
}

model PlayerStats {
  membershipId               BigInt             @map("membership_id")
  activityId                 Int                @map("activity_id")
  clears                     Int                @default(0)
  fullClears                 Int                @default(0) @map("fresh_clears")
  sherpas                    Int                @default(0)
  trios                      Int                @default(0)
  duos                       Int                @default(0)
  solos                      Int                @default(0)
  fastestFullClearInstanceId BigInt?            @map("fastest_instance_id")
  player                     Player             @relation("player_stats_membership_id", fields: [membershipId], references: [membershipId], onUpdate: NoAction, map: "player_membership_id_fkey")
  fastestClear               Activity?          @relation("fastest_raid_clear", fields: [fastestFullClearInstanceId], references: [instanceId])
  activityDefinition         ActivityDefinition @relation(fields: [activityId], references: [id], onUpdate: NoAction, map: "raid_id_fkey")

  @@id([membershipId, activityId])
  @@map("player_stats")
}

model ActivityDefinition {
  id                     Int                     @id(map: "raid_pkey")
  name                   String
  isSunset               Boolean                 @default(false) @map("is_sunset")
  isRaid                 Boolean                 @default(true) @map("is_raid")
  activityHash           ActivityHash[]
  leaderboards           ActivityLeaderboard[]   @relation("leaderboards")
  playerStats            PlayerStats[]
  versionDefinition      VersionDefinition[]
  individualLeaderboards IndividualLeaderboard[] @relation("individual_leaderboard")

  @@map("activity_definition")
}

model ActivityHash {
  hash               BigInt             @id(map: "raid_definition_pkey")
  activityId         Int                @map("activity_id")
  versionId          Int                @map("version_id")
  activity           Activity[]
  activityDefinition ActivityDefinition @relation(fields: [activityId], references: [id], map: "raid_definition_raid_id_fkey")
  versionDefinition  VersionDefinition  @relation(fields: [versionId], references: [id], map: "raid_definition_version_id_fkey")

  @@index([activityId], map: "idx_raid_definition_raid_id")
  @@index([versionId], map: "idx_raid_definition_version_id")
  @@map("activity_hash")
}

model VersionDefinition {
  id                   Int                 @id(map: "raid_version_pkey")
  name                 String
  associatedActivityId Int?                @map("associated_activity_id")
  activityHash         ActivityHash[]
  activityDefinition   ActivityDefinition? @relation(fields: [associatedActivityId], references: [id], map: "raid_version_associated_raid_id_fkey")

  @@map("version_definition")
}

model Activity {
  instanceId                 BigInt                     @id @map("instance_id")
  hash                       BigInt
  flawless                   Boolean?
  completed                  Boolean
  fresh                      Boolean?
  playerCount                Int                        @map("player_count")
  dateStarted                DateTime                   @map("date_started")
  dateCompleted              DateTime                   @map("date_completed")
  duration                   Int
  platformType               Int                        @map("platform_type")
  score                      Int                        @default(0)
  activityHash               ActivityHash               @relation(fields: [hash], references: [hash], onDelete: NoAction, onUpdate: NoAction, map: "activity_hash_fk")
  activityLeaderboardEntries ActivityLeaderboardEntry[]
  activityPlayers            ActivityPlayer[]
  fastestClears              PlayerStats[]              @relation("fastest_raid_clear")

  @@index([hash, dateCompleted], map: "idx_raidhash_date_completed")
  @@index([hash, completed, fresh, duration], map: "speedrun_index")
  @@index([completed, playerCount, fresh, flawless], map: "tag_index")
  @@map("activity")
}

model ActivityPlayer {
  instanceId        BigInt              @map("instance_id")
  membershipId      BigInt              @map("membership_id")
  completed         Boolean
  timePlayedSeconds Int                 @default(0) @map("time_played_seconds")
  sherpas           Int                 @default(0) @map("sherpas")
  isFirstClear      Boolean             @default(false) @map("is_first_clear")
  activity          Activity            @relation(fields: [instanceId], references: [instanceId], onUpdate: NoAction, map: "player_activity_instance_id_fkey")
  player            Player              @relation(fields: [membershipId], references: [membershipId], onUpdate: NoAction, map: "player_activity_membership_id_fkey")
  characters        ActivityCharacter[]

  @@id([instanceId, membershipId], map: "player_activity_instance_id_membership_id_pkey")
  @@index([membershipId], map: "idx_membership_id")
  @@map("activity_player")
}

model ActivityCharacter {
  instanceId        BigInt                    @map("instance_id")
  membershipId      BigInt                    @map("membership_id")
  characterId       BigInt                    @map("character_id")
  classHash         BigInt?                   @map("class_hash")
  emblemHash        BigInt?                   @map("emblem_hash")
  completed         Boolean
  score             Int                       @default(0)
  kills             Int                       @default(0)
  assists           Int                       @default(0)
  deaths            Int                       @default(0)
  precisionKills    Int                       @default(0) @map("precision_kills")
  superKills        Int                       @default(0) @map("super_kills")
  grenadeKills      Int                       @default(0) @map("grenade_kills")
  meleeKills        Int                       @default(0) @map("melee_kills")
  timePlayedSeconds Int                       @map("time_played_seconds")
  startSeconds      Int                       @map("start_seconds")
  activityPlayer    ActivityPlayer            @relation(fields: [instanceId, membershipId], references: [instanceId, membershipId], onUpdate: NoAction)
  weapons           ActivityCharacterWeapon[]

  @@id([instanceId, membershipId, characterId], map: "activity_character_pkey")
  @@index([membershipId], map: "activity_character_idx_membership_id")
  @@map("activity_character")
}

model ActivityCharacterWeapon {
  instanceId     BigInt            @map("instance_id")
  membershipId   BigInt            @map("membership_id")
  characterId    BigInt            @map("character_id")
  weaponHash     BigInt            @map("weapon_hash")
  kills          Int               @default(0) @map("kills")
  precisionKills Int               @default(0) @map("precision_kills")
  character      ActivityCharacter @relation(fields: [instanceId, membershipId, characterId], references: [instanceId, membershipId, characterId], onUpdate: NoAction, map: "activity_character_weapon_fkey")

  @@id([instanceId, membershipId, characterId, weaponHash], map: "activity_character_weapon_pkey")
  @@index([weaponHash], map: "activity_character_weapon_idx_weapon_hash")
  @@map("activity_character_weapon")
}

model ActivityLeaderboard {
  id                String                     @id
  raidId            Int                        @map("raid_id")
  date              DateTime                   @map("date")
  isWorldFirst      Boolean                    @default(false) @map("is_world_first")
  type              WorldFirstLeaderboardType  @map("type")
  entries           ActivityLeaderboardEntry[] @relation("activity_leaderboard_entry_fk")
  activityDefintion ActivityDefinition         @relation("leaderboards", fields: [raidId], references: [id])

  @@unique([raidId, type], map: "leaderboard_raid_hash_type_key")
  @@map("leaderboard")
}

model ActivityLeaderboardEntry {
  rank          Int
  position      Int
  leaderboardId String              @map("leaderboard_id")
  instanceId    BigInt              @map("instance_id")
  activity      Activity            @relation(fields: [instanceId], references: [instanceId], onDelete: NoAction, onUpdate: NoAction)
  leaderboard   ActivityLeaderboard @relation("activity_leaderboard_entry_fk", fields: [leaderboardId], references: [id], onDelete: Cascade)

  @@id([leaderboardId, instanceId])
  @@index([leaderboardId, position], map: "activity_leaderboard_position")
  @@index([instanceId], map: "activity_leaderboard_entry_instance_id_index")
  @@map("activity_leaderboard_entry")
}

model PGCR {
  instanceId  BigInt    @id @map("instance_id")
  data        Bytes
  dateCrawled DateTime? @default(now()) @map("date_crawled") @db.Timestamp(6)

  @@map("pgcr")
}

model migrations {
  id        Int       @id
  name      String
  appliedAt DateTime? @default(now()) @map("applied_at") @db.Timestamp(6)

  @@map("_migrations")
}

enum WorldFirstLeaderboardType {
  Normal
  Challenge
  Prestige
  Master
}

view IndividualLeaderboard {
  activityId   Int                @map("raid_id")
  membershipId BigInt             @map("membership_id")
  activity     ActivityDefinition @relation("individual_leaderboard", fields: [activityId], references: [id])
  player       Player             @relation("individual_leaderboard", fields: [membershipId], references: [membershipId])

  clears             Int
  clearsPosition     Int @map("clears_position")
  clearsRank         Int @map("clears_rank")
  fullClears         Int @map("fresh_clears")
  fullClearsPosition Int @map("fresh_clears_position")
  fullClearsRank     Int @map("fresh_clears_rank")
  sherpas            Int
  sherpasPosition    Int @map("sherpas_position")
  sherpasRank        Int @map("sherpas_rank")
  trios              Int
  triosPosition      Int @map("trios_position")
  triosRank          Int @map("trios_rank")
  duos               Int
  duosPosition       Int @map("duos_position")
  duosRank           Int @map("duos_rank")
  solos              Int
  solosPosition      Int @map("solos_position")
  solosRank          Int @map("solos_rank")

  @@unique([activityId(sort: Desc), membershipId(sort: Asc)], name: "uniqueRaidMembershipId", map: "idx_individual_leaderboard_clears_membership_id")
  @@unique([activityId(sort: Desc), clearsPosition(sort: Asc)], map: "idx_individual_leaderboard_clears")
  @@unique([activityId(sort: Desc), fullClearsPosition(sort: Asc)], map: "idx_individual_leaderboard_fresh_clears")
  @@unique([activityId(sort: Desc), sherpasPosition(sort: Asc)], map: "idx_individual_leaderboard_sherpas")
  @@unique([activityId(sort: Desc), triosPosition(sort: Asc)], map: "idx_individual_leaderboard_trios")
  @@unique([activityId(sort: Desc), duos(Positionsort: Asc)], map: "idx_individual_leaderboard_duos")
  @@unique([activityId(sort: Desc), solosPosition(sort: Asc)], map: "idx_individual_leaderboard_solos")
  @@map("individual_leaderboard")
}

view GlobalLeaderboard {
  membershipId BigInt @unique @map("membership_id")
  player       Player @relation("global_leaderboard", fields: [membershipId], references: [membershipId])

  clears             Int
  clearsPosition     Int  @unique @map("clears_position")
  clearsRank         Int  @map("clears_rank")
  fullClears         Int  @map("fresh_clears")
  fullClearsPosition Int  @unique @map("fresh_clears_position")
  fullClearsRank     Int  @map("fresh_clears_rank")
  sherpas            Int
  sherpasPosition    Int  @unique @map("sherpas_position")
  sherpasRank        Int  @map("sherpas_rank")
  speed              Int?
  speedPosition      Int  @unique @map("speed_position")
  speedRank          Int  @map("speed_rank")

  @@map("global_leaderboard")
}

view WorldFirstPlayerRanking {
  membershipId Int   @unique @map("membership_id")
  score        Float
  rank         Int

  @@index([rank(Sort: Asc)], map: "idx_world_first_player_ranking_rank")
  @@map("world_first_player_ranking")
}
