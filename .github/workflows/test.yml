name: Run Tests

on:
    push:
        branches:
            - update-manifest

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Install cloudflared
              run: |
                  sudo apt update
                  sudo apt-get install cloudflared
                  cloudflared --version

            - name: Load SSH Key
              uses: shimataro/ssh-key-action@v2
              with:
                  key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
                  known_hosts: ${{ secrets.VPS_SSH_KNOWN_HOSTS }}
                  name: gapk
                  if_key_exists: ignore

            - name: Tunnel to VPS
              run: |
                  ssh -L 5432:localhost:5432 -o ProxyCommand="cloudflared access ssh --hostname %h -H 'CF-Access-Client-Id: ${{ secrets.CF_GHA_CLIENT_ID }}' -H 'CF-Access-Client-Secret: ${{ secrets.CF_GHA_CLIENT_SECRET }}'" -i ~/.ssh/gapk root@ssh.raidhub.app

            - name: Run Tests
              run: |
                  yarn && yarn prisma generate
                  yarn test
