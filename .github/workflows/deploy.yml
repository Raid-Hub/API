name: Deploy to VPS on Push

on:
    push:
        branches:
            - test

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Cloudflare Warp Client Setup
              uses: Boostport/setup-cloudflare-warp@v1
              with:
                  organization: raidhub
                  auth_client_id: ${{ secrets.CLOUDFLARE_AUTH_CLIENT_ID }}
                  auth_client_secret: ${{ secrets.CLOUDFLARE_AUTH_CLIENT_SECRET }}

            - name: Install cloudflared
              run: |
                  curl -L https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-archive-keyring.gpg >/dev/null
                  echo "deb [signed-by=/usr/share/keyrings/cloudflare-archive-keyring.gpg] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" | sudo tee  /etc/apt/sources.list.d/cloudflared.list
                  sudo apt update
                  sudo apt-get install cloudflared
                  cloudflared --version

            - name: Load SSH Key
              uses: shimataro/ssh-key-action@v2
              with:
                  key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
                  known_hosts: ${{ secrets.VPS_SSH_KNOWN_HOSTS }}
                  name: gapk
                  if_key_exists: fail

            - name: Deploy API
              run: ssh -o ProxyCommand="cloudflared access ssh --hostname ssh.raidhub.app" root@ssh.raidhub.app "~/../RaidHub/RaidHub-API/deploy.sh
